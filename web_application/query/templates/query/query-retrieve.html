{% extends 'rest_framework/api.html' %}
{% load staticfiles %}
{% load rest_framework %}
{% load i18n %}
{% load internal_extras %}
{% block title %}Query Result{% endblock %}
{% block head-extra %}
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/css/data-tables/data-tables.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/css/ace/ace.css' %}"/>

<link rel="stylesheet" type="text/css" href="{% static 'query/css/schema-browser/schema-browser.min.css' %}"/>
<link rel="stylesheet" href="{% static 'query/css/query-builder/query-builder.min.css' %}" type="text/css"/>

<script type="text/javascript" src="{% static 'query/js/available-products/controllers.js' %}"></script>
<script type="text/javascript" src="{% static 'query/js/available-products/services.js' %}"></script>
<script type="text/javascript" src="{% static 'query/js/available-products/components.js' %}"></script>

{% endblock %}

{% block page_title %}Query Result{% endblock %}
{% block useful_links %}
<li role="presentation" ><a href="{% url 'documentation:topic-detail' slug='query' %}" title="Query Documentation">Documentation</a></li>
{% endblock useful_links %}
{% block page_title_banner_class %}yellow{% endblock %}


{% block content-test %}
<div class="row">
    <div class="col-sm-2 col-xs-12 sidebar">
        <div class="sidebar-contents">
            <h5>Page Contents</h5>
            <ul  class="nav nav-pills nav-stacked docs-sidebar">
                <li><a href="#results" class="scroll">Results</a></li>
                <li><a href="#download" class="scroll">Download</a></li>
                <li><a href="#select_data_products" class="scroll">Select Data Products to Download</a></li>
                <li><a href="#update" class="scroll">Update or Delete this Query</a></li>
            </ul>
            <h5>Quick Links</h5>
            <ul  class="nav nav-pills nav-stacked docs-sidebar">
                <li><a href="{% url 'query-list' %}" class=""><i class="fa fa-reply"></i> Back to Query History</a></li>
                <li role="presentation" ><a href="{% url 'query-create-list' %}">New Query</a></li>
            </ul>
        </div>


    </div>
    <div class="col-sm-10 main-content">
    <div class="row">
        <div class="col-xs-8"><h2>{{response.data.title}} <small class="sub-heading" style="margin-top:18px;">Last updated: {{response.data.updated}}</small></h2></div>
        <div class="col-xs-4">
            <a class="sub-heading pull-right" href="{% url 'user-profile-detail' username=user %}" title="Go to My Account">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-user fa-stack-1x fa-inverse"></i>
                </span>
                {{user|upper}}
            </a>
        </div>
    </div>
    {% if response.data.queryResults %}
    {# ------ ACTIONS ------#}
    <div class="row">
        <div class="col-xs-12"><br>
            <div class="well">
                <p class="lead no-margin-bottom">
                    What can I do?
                </p>
                <ul class="p">
                    <li>View the <a href="#result" class="scroll">result</a> of <em>{{response.data.title}}</em>.</li>
                    <li><a href="#download" class="scroll">Download</a> the table of results.</li>
                    <li>If your query returned astronomical objects, you can <a href="#select_data_products" class="scroll">select</a> data products to download.</li>
                    <li><a href="#update" class="scroll">Update or delete</a> the query from your Query History.</li>
                </ul>
            </div>
        </div>
    </div>

    {# ------RESULT ------#}
    <div class="row" id="result">
        <div class="col-sm-12">
            <h2>Result</h2>
            <div id="TableResultsWarning"></div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div class="data-table-container" id="data-table-container"><p><i class="fa fa-refresh fa-spin"></i> Fetching Data...</p></div>
        </div>
    </div>

    {# ------DOWNLOAD ------#}
    <div class="row">
        <div class="col-xs-12" id="download">
            <h3 class="headline"><span>Download</span> </h3>
            <h4 class="headline" id="download"><span>Catalogue Data</span> </h4>
            <p>Download the results of you query in json or csv format. If your preferred format isn't available, make a feature request.</p>
            {% for f in available_formats %}
                {% if f != "api" %}
                    <a href="{{request.get_full_path}}?format={{f}}" class="btn btn-default">
                        <span class="fa-custom-stack">
                          <i class="fa fa-file-o"></i>
                            <span class="fa-custom-filetype">{{f}}</span>
                        </span>{{f}}
                    </a>
                {% endif %}
            {% endfor %}

            <!--<add-download-button url='{{ request.get_full_path }}' formats='[{% for f in available_formats %}{% if f != "api" %}"{{f}}"{% endif %}{% if not forloop.last and f != "api" %},{% endif %}{%endfor%}]'></add-download-button>-->
        </div>
    </div>
    <div class="row" id="select_data_products">
        <div class="col-xs-12">
            <h4 class="headline"><span>Additional Products</span> </h4>
        </div>
        <div class="col-xs-12">
            <p>Download additional data products for the objects in this query.</p>
            <div class="panel panel-default info">
                <div class="panel-body">
                    <strong class="text-uppercase">Note</strong>
                    <p class="small">
                        This selection tool displays all available types of data product hosted at ADC.
                        However, not all data products are available for all objects (e.g., some GAMA galaxies will
                        <strong>not</strong> have
                        SAMI data). Once you have made your selection and downloaded the data, check the download package for
                        details on unavailable products.
                    </p>
                </div>
            </div>
        </div>
        {% block data-download %}
            <div class="col-xs-12">
                <!--<available-products schemaurls="{'SAMI':'{% url 'schema:astroobject-list' sample_pk='sami' astroobject_pk='9352' %}', 'GAMA':'{% url 'schema:astroobject-list' sample_pk='sami' astroobject_pk='9352' %}'}"></available-products>-->
                <available-products schemaurls="{'SAMI':'{% url 'schema:sample-list' sample_pk='sami' %}'}"></available-products>
            </div>
        {% endblock %}
    </div>

    {# ------UPDATE ------#}
    <div class="row" id="update">
        <div class="col-sm-offset-0 col-sm-8 col-xs-12">
            <h3>Update  <small class="pull-right sub-heading" style="margin-top:18px;">Last Updated: {{response.data.updated}}</small></h3>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <span class="panel-title">Update</span>
                    <a href="{% url 'documentation:topic-detail' slug='query' %}" class="pull-right question"><i class="fa fa-question-circle"></i> Need Query Help?</a>
                </div>
                <div class="panel-body">
                    <p>Update the SQL for this query and re-run (if you change only the title, the SQL will not be re-run).
                        Submitting this form will <strong>override</strong> the previous query and results.
                        Alternatively, you can create a <a type="button" class="" href="{% url 'query-create-list' %}">New Query</a>.
                    </p>
                    {% if put_form %}
                    <div class="" id="put-object-form">
                        <form action="{{ request.get_full_path }}" data-method="PUT" enctype="multipart/form-data"
                              class="form-horizontal" novalidate>
                            {{ put_form }}
                            <div class="row">
                                <div class="col-xs-12">
                                    <div class="text-right">
                                        <button class="btn btn-default js-tooltip"
                                                title="Overwrite Query {{objname}}" id="button-sql-update">UPDATE
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-sm-4 col-xs-12">
            <h3>Summary</h3>
            <div class="panel panel-default" ng-if="ctrl.items | isNotEmpty">
                <!-- List group -->
                <ul class="list-group summary">
                    <li class="list-group-item">Download ID <span class="badge">{{response.data.id}}</span></li>
                    <li class="list-group-item">Updated<span class="badge">{{response.data.updated}}</span></li>
                    <li class="list-group-item">Rows<span class="badge">-</span>
                    </li>
                </ul>
                <div class="panel-body">
                    <p class="sub-heading" style="margin-bottom:0;">Deleting a query is irreversible. Please be sure you wish to proceed.</p>
                    <form class="custom-inline text-right" action="{{ request.get_full_path }}"
                          data-method="DELETE">
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="text-right">
                                    <button type="button" class="btn btn-sm btn-default btn-error js-tooltip"
                                            title="DELETE this query" id="DELETE_RESOURCE"
                                            data-toggle="modal">DELETE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <!-- Confirmation modal -->
                    <div class="modal fade" id="delete-modal-sm" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-body">
                                    <strong> ARE YOU SURE? </strong>
                                    <p>Deleting queries is irreversible. </p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" data-dismiss="modal" class="btn btn-sm btn-default">CANCEL</button>
                                    <button type="button" data-dismiss="modal" class="btn btn-sm btn-error" id="delete">DELETE
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    </div>
</div>
{% endblock %}


{% comment %}
------ ACE EDITOR FOR ANY SQL INPUTS ------
{% endcomment %}
{% block footer-extra %}
<script src="{% static 'restapi_app/js/ace-min-noconflict/ace.js' %}"></script>

<script type="text/javascript">
        $(document).ready(function() {
            $('form').ajaxForm();

            // CODE EDITOR
            $(function () {
                //Hide the results form group to prevent users trying to patch results
                //back-end will drop this if tampered with
                $('input[name="queryResults"]').parents('.form-group').hide();

                // SQL
                $('textarea[name=SQL]').each(function () {
                    $('form').find('textarea[name=SQL]').attr('id','textarea-code');

                    // clear out parent container
                    $('#textarea-code').parent().not(':first').remove();
                    $('#textarea-code').parent().append('<div id="SQL-ace-editor" class="ace-editor-class" style="height: auto;min-height:100px"></div>');
                    var textarea = $('#textarea-code').css('display', 'none');

                    var SQLAceEditor = ace.edit("SQL-ace-editor");
                    SQLAceEditor.$blockScrolling = Infinity;
                    SQLAceEditor.setTheme("ace/theme/crimson_editor");
                    SQLAceEditor.setOption("maxLines", 30);
                    SQLAceEditor.setOption("minLines", 5);
                    SQLAceEditor.setOption("wrap", 50);
                    SQLAceEditor.getSession().setMode("ace/mode/sql");
                    SQLAceEditor.getSession().setValue(textarea.val());
                    SQLAceEditor.getSession().on('change', function(){
                        textarea.val(SQLAceEditor.getSession().getValue());
                        SQLAceEditor.resize(true);
                    });
                });
            });
            $('#button-sql-update').click(function(){
                $(this).attr('disabled','disabled');
                $(this).html('SUBMITTING... <i class="fa fa-refresh fa-spin fa-1x fa-fw"></i>');
                $('#put-object-form form').submit();
            });
        });
</script>

{% comment %}
------ TURN ON DATATABLES ------
{% endcomment %}
<script src="{% static 'restapi_app/js/data-tables/dataTables.js' %}"></script>

{% autoescape off %}
 <script type="text/javascript">

    var SAMI_URL = "{% url 'data_browser:survey-list' sample_pk='sami' %}";
    var GAMA_URL = "{% url 'data_browser:survey-list' sample_pk='gama' %}";


    var DOWNLOAD_URL = "{% url 'download-create'%}";

    data = JSON.parse("{{ content|escapejs }}");

    if (typeof data.queryResults !== 'undefined'){
        $('#data-table-container').html(' ')
                .append('<div class=""><div id="returnTableResultsWarning" class="spacer-10"></div><table id="returnTableResults" class="table table-responsive table-condensed"><thead><tr><th>Please wait, DataTable loading... <i class="fa fa-refresh fa-spin"></i></th></tr></thead></table></div>')

        render_limit = 10000;
        query_data = (data.queryResults);

        query_data_row_length = query_data.data.length;
        query_data_col_length = query_data.columns.length;

        if (data.flag != "") {
            $('#TableResultsWarning').append('<div class="row"><div class="col-sm-12"><div class="panel panel-default warning"><div class="panel-body"><strong class="text-uppercase">Warning</strong><p class="small">Displaying '+data.flag.new_query_results_rows+' out of '+data.flag.query_results_rows+' rows. Please download the CSV file to explore the full set of results.</p></div></div></div></div>');
            render_limit = data.flag.render_limit;
        }

        if((typeof query_data !== 'undefined') && query_data.data.length < render_limit){
            var queryColumns = [];
            var thead = '';
            $('#returnTableResults').find('thead > tr').empty();
            //APPEND COLUMN VALUES TO TABLE HEAD
            $.each(query_data.columns, function(i,k){
                var b = { title: k };

                if (k.indexOf("url_img") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            return '<img class="img-responsive" style="max-width:70px" src="'+data+'" />';
                        }
                    }
                }
                if (k.indexOf("data_browser_url") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            var temp_string = '<a href="'+data+'" target="_blank">'+data+'</a>';
                            return temp_string;
                        }
                    }
                }
                if (k.indexOf("sami_id") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            var temp_string = '<a href="'+SAMI_URL+data+'">'+data+'</a>';
                            return temp_string;
                        }
                    }
                }
                if (k.indexOf("CATAID") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            var temp_string = '<a href="'+GAMA_URL+data+'">'+data+'</a>';
                            return temp_string;
                        }
                    }
                }
                th = '<th>'+k+'</th>';
                queryColumns.push(b);
                $('#returnTableResults').find('thead > tr').append(th);
            });
            var data = query_data.data;

            if (typeof data == 'undefined'){data=[];}

            var table = $('#returnTableResults').DataTable( {
                data : data,
                columns : queryColumns,
                "orderClasses": false,
                "scrollX": true,
                "deferRender": true,
                "language": {
                    "loadingRecords": "Please wait - loading..."
                }
            });

            $('#returnTableResults_filter input').unwrap().wrap("<div class='input-group' role='search'></div>")
                    .addClass('form-control')
                    .attr('placeholder', 'SEARCH...')
                    .after('<span class="input-group-btn"> <button class="btn btn-default btn-sm" type="button"><i class="fa fa-search fa-fw"></i></button> </span>');
            document.getElementById('returnTableResults_filter').firstChild.data = "";
            $('#returnTableResults_length, #returnTableResults_filter').parent('.col-sm-6').addClass('col-xs-6');

        };
    };
    {% endautoescape %}
</script> 

{# ------ CONFIRM RESOURCE DELETE ------ #}
<script>
    $(document).ready(function(){
        $('#DELETE_RESOURCE').on('click', function(e){
            var $form=$(this).closest('form');
            e.preventDefault();
            $('#delete-modal-sm').modal({ backdrop: 'static', keyboard: false })
            .one('click', '#delete', function (e) {
                $form.trigger('submit');
            });
        });
    });


    fTabSwitch = function(id){
        $('[href=#'+id+']').tab('show');
    }

</script>


<script>
    $(document).ready(function () {
        $(".scroll").click(function (event) {
            // stop the hash being appended to the url, and scroll to the value
            event.preventDefault();
            $('html, body').animate({scrollTop: $(this.hash).offset().top}, 800);
        });
    });
</script>

{# ----- Change the text shown in the branch button. ----- #}
<script>
    $('.branch_dropdown ul.dropdown-menu > li > a').click(function (event) {
        console.log(event);
        // note, currentTarget gets the element to which the event handler was attached to (rather than target, which gets the element on which the event occurred)
        var _anchor = $(event.currentTarget);
        // get nearest button

        // optional version description
        var _vers_description_colon = '';
        var _branch_description_colon = '';
        if (!!_anchor.attr('data-version-description')){_vers_description_colon=':'}
        if (!!_anchor.attr('data-branch-description')){_branch_description_colon=':'}

        var _branch = "<span class='sub-heading'><i class='fa fa-code-fork'></i> Branch </span><strong>" + _anchor.attr('data-branch') + _branch_description_colon + "</strong> " + _anchor.attr('data-branch-description') + " <i class='fa fa-caret-down'></i>";
        var _version = "<span class='sub-heading'><i class='fa fa-map-pin'></i> Version </span><strong>" + _anchor.attr('data-version') + _vers_description_colon + "</strong> " + _anchor.attr('data-version-description') + " <i class='fa fa-caret-down'></i>";

        if (!!_anchor.attr('data-version')){
            _anchor.closest('ul.version-selector').find('a.branch_button').html(_version)
        } else {
            _anchor.closest('ul.branch-selector').find('a.branch_button').html(_branch)
        }

        // Update the branch_warning message with this branch and version
        _anchor.closest('.trait').find('span.branch_warning-branch').html(_anchor.attr('data-branch'));
        _anchor.closest('.trait').find('span.branch_warning-version').html(_anchor.attr('data-version'));

    });
</script>
{% endblock %}

