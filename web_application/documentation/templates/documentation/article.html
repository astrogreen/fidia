{% extends 'rest_framework/api.html' %}
{% load staticfiles %}
{% load rest_framework %}
{% load internal_extras %}
{% block title %} Help Center {% endblock %}

{% block head-extra %}
{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'index' %}">Home</a></li>
<li><a href="{% url 'documentation:topic-list' %}"> Help Center</a></li>
{% if response.data.title %}
<li><a href="{% url 'documentation:topic-detail' slug=response.data.topic_info.slug %}">{{response.data.topic_info.title|capfirst}}</a></li>
<li><a href="{{response.data.url}}"> {{response.data.title}}</a></li>
{% endif %}
{% endblock %}

{% block page_title %} Help Center {% endblock %}
{% block page_title_banner_class %}blue{% endblock %}
{% block useful_links %}
<li><a href="{% url 'documentation:topic-list' %}" title="Help Center Home"> <i class="fa fa-home fa-lg"></i></a></li>
{% endblock useful_links %}


{% block sidebar %}
{% if not response.data.content %}
<div class="page-contents">
    <h5>Page Contents</h5>
    <ul class="nav-sidebar">
        <li>
            <a href="{% url 'documentation:topic-list' %}"><i class="fa fa-angle-left"></i> Cancel and return to Help Center</a>
        </li>
    </ul>
</div>
{% endif %}

{% if response.data.topic_info %}
<div class="quick-links">
    <h5>Quick Links</h5>
    <ul class="nav-sidebar">
        <li>
            <a href="{% url 'documentation:topic-detail' slug=response.data.topic_info.slug %}"><i class="fa fa-angle-left"></i> Back to all {{response.data.topic_info.title|capfirst}} articles </a>
        </li>
    </ul>
</div>
{% endif %}
{% endblock %}
{% block version_container %}

{% endblock %}
{% block main %}
{% if response.status_code == 201 %}
    <div class="row">
        <div class="col-xs-12">
            <h2>New Article Created</h2>
            <p>Your article entitled <em>{{response.data.title}}</em> was successfully created on <em>{{response.data.created}}</em>. Click the link to view: <a
                    href="{{response.data.url}}">{{response.data.title}}</a>.</p>
        </div>
    </div>
    {% endif %}

    {% if not response.data.content %}

    <div class="row">

        <div class="col-xs-12">
            {% if post_form %}
                <h2>Add New Article</h2>
                {% with form=post_form %}
                    <form action="{{ request.get_full_path }}" method="POST" enctype="multipart/form-data" class="form-horizontal" novalidate onsubmit="submitForm()">
                      <fieldset>
                        {% csrf_token %}
                        {{ post_form }}
                        <div class="form-actions">
                          <button class="btn btn-default pull-right" title="Make a POST request on the {{ name }} resource">SUBMIT</button>
                        </div>
                      </fieldset>
                    </form>
                  {% endwith %}
            {% endif %}

            <h2>All Articles</h2>
            {% if response.data.results %}
                {% if not topic.hidden %}
                <ul class="p sub-heading">
                    {% for this in response.data.results %}
                    <li>
                        <a href="{{this.url}}">{{this.title}}</a>
                        <p class=""><span class="tiny sub-heading"> Last updated {{this.updated}}</span> <a href="{% url 'documentation:topic-detail' slug=this.topic_info.slug %}">#{{this.topic_info.title}}</a></p>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            {% else %}
            <p>No articles have been added yet.</p>
            {% endif %}

        </div>
    </div>

    {% else %}
    <div class="row">
        <div class="col-xs-12 col-sm-9">
            <h2>{{response.data.title}} <br>
                <small class="tiny sub-heading">
                        Last updated {{response.data.updated}}</small>
            </h2>

            {{response.data.content |safe}}
        </div>
        <div class="col-sm-3 col-hidden-xs">
            <h5>Related articles</h5>
            <ul class="nav nav-sidebar">
                {% for article in response.data.all_articles_in_topic %}
                    {% if article.title != response.data.title %}
                        {% if not article.hidden %}
                            <li><a style="padding-left:0;padding-right:0" href="{{article.url}}"> {{article.title}}</a></li>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </ul>

        </div>
    </div>
        {% if put_form %}

        <div class="row">
            <div class="col-xs-12">
                <h2>Update</h2>
                <div class="tab-pane" id="put-object-form">
                    <form id="PUT_FORM" action="{{ request.get_full_path }}" data-method="PUT" enctype="multipart/form-data" class="form-horizontal" novalidate onsubmit="submitForm(this)">
                        <fieldset>
                            {% csrf_token %}
                            {{ put_form }}
                            <div class="form-actions">
                                <button class="btn btn-default pull-right js-tooltip"
                                        title="Make a PUT request on the {{ name }} resource">UPDATE
                                </button>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>

        <script>
            $(document).ready(function(){
                _selector = '#PUT_FORM input[type="file"]';
                $(_selector).closest('.form-group .col-sm-10').append('<p class="tiny" id="current_file_info">Current file: '+$(_selector).attr('value')+' </p>');
//                $(_selector).click(function(){
//                    $('#current_file_info').html('<p class="tiny">Current file: '+$(this).attr('value')+' </p><p class="warning"><strong>Warning</strong> You are about to override the image on file.</p>');
//                })
            });

        </script>

        {% endif %}

        {% if request.user.is_superuser %}
            <form class="custom-inline" action="{{ request.get_full_path }}"
                  data-method="DELETE">
                <button type="button" class="btn btn-sm btn-default btn-error js-tooltip"
                        title="DELETE this query" id="DELETE_RESOURCE"
                        data-toggle="modal">DELETE
                </button>
            </form>
            <!-- Confirmation modal -->
            <div class="modal fade" id="delete-modal-sm" tabindex="-1" role="dialog">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-body">
                            <strong> ARE YOU SURE? </strong>
                            <p>Deleting articles is irreversible. </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" data-dismiss="modal" class="btn btn-sm btn-default">CANCEL</button>
                            <button type="button" data-dismiss="modal" class="btn btn-sm btn-error" id="delete">DELETE
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    {% endif %}
{% endblock %}


{% block footer-extra %}
<script src="{% static 'restapi_app/js/tinymce/tinymce.min.js' %}"></script>
<script>
    tinymce.init({
        selector: 'textarea',
        allow_html_in_named_anchor: true,
        height: 500,
        plugins: [
            'advlist autolink lists link charmap print preview anchor',
            'searchreplace visualblocks code fullscreen',
            'insertdatetime table contextmenu paste code',
            'fontawesome noneditable'
        ],
        toolbar: 'insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link | fontawesome',
        content_css: "https://netdna.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css, {% static 'restapi_app/less/main/main.css' %}",
        noneditable_noneditable_class: 'fa',
        extended_valid_elements: 'span[*]'
    });
    function submitForm() {
        console.log('submitform');
        tinymce.triggerSave();
        console.log('triggersave ok');
        // unbind the warning for leaving the page
//        window.onbeforeunload = null;
        return false
//        document.forms[0].submit();
    }
</script>

{% if request.user.is_superuser %}

{# ------ CONFIRM RESOURCE DELETE ------ #}
<script>
    $(document).ready(function () {
        $('#DELETE_RESOURCE').on('click', function (e) {
            console.log('click')
            var $form = $(this).closest('form');
            e.preventDefault();
            $('#delete-modal-sm').modal({backdrop: 'static', keyboard: false})
                    .one('click', '#delete', function (e) {
                        $form.trigger('submit');
                    });
        });

        $('.zoom').hover(function () {
            $(".zoom").addClass('transition');

        }, function () {
            $(".zoom").removeClass('transition');
        });
    });

    // warn user if leaving the page - if unsaved data
    window.onbeforeunload = confirmExit;
    function confirmExit() {
        return "You are leaving this page. If you have made any changes without clicking the Update button, your changes will be lost.  Are you sure you want to exit this page?";
    }

</script>

{% endif %}
{% endblock %}