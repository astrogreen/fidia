{% extends 'rest_framework/api.html' %}
{% load staticfiles %}
{% load rest_framework %}
{% load i18n %}
{% load internal_extras %}
{% block title %}Query{% endblock %}
{% block head-extra %}
<!--<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/s/bs/dt-1.10.10/datatables.min.css"/>-->
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/less/query/data-tables.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/less/schema-browser/schema-browser.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/less/ace/ace.css' %}"/>
<link rel="stylesheet" href="{% static 'restapi_app/less/query/query-builder.css' %}" type="text/css"/>
<style type="text/css">
    table{
        table-layout: fixed;
    }
    table tr {
        height:1em;
    }
    td {
        overflow:hidden;white-space:nowrap;
    }
    .nav-pagination{
        background-color:transparent;
        float:right;
    }
    #SQL-ace-editor{border:solid 1px #eeeeee;}

</style>
{% block head-extra-extra%}{% endblock %}
{% endblock %}

{% block bodyclass %}{% endblock %}
{% block breadcrumbclass %}{% endblock %}


{% block content-filter-form %}{% endblock %}
{% block content-header %}{% endblock %}

{% block content %}
    {% comment %}
    ------ NEW QUERY FORM ------
    {% endcomment %}
    {% if display_edit_forms %}
        {% if post_form or raw_data_post_form %}
            {% if not response.data.queryResults %}
            <h1 class="headline">
                <span>Query</span>
                <div class="btn-group on-this-page-btn-group pull-right" role="group" aria-label="...">
                    <!--<button type="button" class="btn btn-default btn-sm text-uppercase" onclick="fTabSwitch('post-object-form')" title="Query the ASVO-AAT Node database.">SQL</button>-->
                    <a type="button" class="btn btn-default btn-sm text-uppercase" href="{% url 'documentation-query-builder' %}" title="Query Documentation">Documentation</a>
                    <a type="button" class="btn btn-default btn-sm text-uppercase" href="#query-history" title="Re-visit previous queries.">Query History</a>
                </div>
            </h1>
            <div class="row">
                <div class="col-sm-12">
                    <p>Submit an <a onclick="fTabSwitch('post-object-form')" title="Query the ASVO-AAT Node database.">SQL</a>
                        (Structured Query Language) query to the ASVO-AAT Node database via the form below.</p>
                    <p>The <a onclick="fTabSwitch('query-builder-form')" title="Create simple SQL queries with ease.">Query Builder</a> allows you to construct long and complicated
                        SQL queries without prior knowledge of the syntax.
                    </p>
                    <p>Re-visit and manage
                        your past queries in <a href="#query-history" title="Re-visit previous queries.">Query History</a>. </p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-8">
                     <h2 class="headline" id="new-query">
                        <span>New Query</span>
                    </h2>
                    <div class="tabbable">
                        {% if post_form %}
                        <ul class="nav nav-tabs form-switcher">
                            <li>
                                <a name='html-tab' href="#post-object-form" data-toggle="tab">SQL Form</a>
                            </li>
                            <li>
                                <a name='raw-tab' href="#query-builder-form" data-toggle="tab">Query Builder</a>
                            </li>
                        </ul>
                        {% endif %}
                        <div class="well tab-content">
                            {% if post_form %}
                            <div class="tab-pane" id="post-object-form">
                                {% with form=post_form %}
                                <form action="{{ request.get_full_path }}" method="POST" enctype="multipart/form-data" class="form-horizontal" novalidate>
                                    <fieldset>
                                        {% csrf_token %}
                                        {{ post_form }}
                                        <div class="form-actions">
                                            <button class="btn btn-primary btn-sm pull-right" title="Make a POST request on the {{ name }} resource" id="button-sql-submit">SUBMIT</button>
                                        </div>
                                    </fieldset>
                                </form>
                                {% endwith %}
                            </div>
                            {% endif %}

                            <div id="query-builder-form" class="tab-pane">
                                {% block query-builder %}{% endblock %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                     <h2 class="headline">
                        <span>Schema</span>
                    </h2>
                    {% block schema-browser %}
                        {% include "restapi_app/query/schema-browser-module.html" %}
                    {% endblock %}
                </div>
            </div>
            {% endif %}
        {% endif %}
    {% endif %}

    {% comment %}
    ------ QUERY HISTORY TABLE ------
    {% endcomment %}

    {% if response.data.count > 0 %}
        <h2 class="headline" id="query-history">
            <span>Query History</span>
        </h2>
        <div class="well">
            {% for key, value in response.data.items %}
                {% if key == "results" %}
                    {% comment %}{{ key }} : {{ value }}<br>{% endcomment %}
                    <div class="table-responsisve">
                        <table class="table table-condensed">
                            <colgroup>
                                <col span="1" style="width: 25%;">
                                <col span="1" style="width: 50%;">
                                <col span="1" style="width: 25%;">
                            </colgroup>
                            <thead>
                            <tr>
                                <th>Title</th>
                                <th>SQL</th>
                                <th>Date</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for valueb in value %}
                            {% comment %}{{ valueb }} <br>{% endcomment %}
                            <tr>
                                <td><a href="{{valueb.url}}" class=" text-uppercwase"> {{ valueb.title }} </a></td>
                                <td>{{valueb.SQL}}</td>
                                <td>{{valueb.updated}}</td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% endfor %}

            {% if 'GET' in allowed_methods %}
                <form id="get-form" class="text-right">
                    <fieldset>
                        {% if api_settings.URL_FORMAT_OVERRIDE %}
                        <div class="btn-group format-selection">
                            <a class="btn btn-default  btn-sm js-tooltip" href="{{ request.get_full_path }}" rel="nofollow"
                               title="Download user {{user}}'s {{ name }} by format type">Download Query List</a>
                            <button class="btn btn-default btn-sm dropdown-toggle js-tooltip" data-toggle="dropdown" title="Specify a format for data download">
                                <span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu">
                                {% for format in available_formats %}
                                <li>
                                    <a class="js-tooltip format-option" href="{% add_query_param request api_settings.URL_FORMAT_OVERRIDE format %}"
                                       rel="nofollow" title="Download {{ name }} with the format set to `{{ format }}`">{{ format }}</a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% else %}
                            <a class="btn btn-default btn-sm js-tooltip" href="{{ request.get_full_path }}" rel="nofollow"
                               title="View user {{user}}'s {{ name }}">GET</a>
                        {% endif %}
                    </fieldset>
                </form>
            {% endif %}
        </div>
        {% if paginator %}
            <nav class="nav-pagination">
                {% get_pagination_html paginator %}
            </nav>
        {% endif %}
    {% endif %}

    {% comment %}
    ------DATATABLES ------
    {% endcomment %}
    {% if response.data.queryResults %}
        <div class="row">
            <div class="col-sm-6">
                <h1 class="headline">
                    <span>Query <small># {{objname}}</small></span>
                </h1>
            </div>
            <div class="col-sm-6">
                <div class="btn-group btn-group-head pull-right" role="group" aria-label="">
                    {% block content-download %}
                        {% if 'GET' in allowed_methods %}
                            <form id="download-list" class="custom-inline">
                                {% if api_settings.URL_FORMAT_OVERRIDE %}
                                <div class="btn-group format-selection">
                                    <button class="btn btn-default btn-sm dropdown-toggle js-tooltip" data-toggle="dropdown" title="Specify a format for data download">
                                        DOWNLOAD <i class="fa fa-caret-down"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        {% for format in available_formats %}
                                        {% if format != "api" %}
                                            <li>
                                                <a class="js-tooltip" href="{% add_query_param request api_settings.URL_FORMAT_OVERRIDE format %}"
                                                   rel="nofollow" target="_blank"  title="Download query # {{ objname }} with the format set to `{{ format }}`">{{ format }}</a>
                                            </li>
                                        {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% else %}
                                    <a class="btn btn-default btn-sm js-tooltip" href="{{ request.get_full_path }}" rel="nofollow"
                                       title="Download {{user}}'s query # {{objname}}">PERMANENT LINK</a>
                                {% endif %}
                            </form>
                        {% endif %}
                    {% endblock %}
                    <a type="button" class="btn btn-default btn-sm text-uppercase" href="{% url 'query-list' %}"><i
                        class="fa fa-caret-left"></i> Back to Query History</a>
                    <a type="button" class="btn btn-default btn-sm text-uppercase" href="{% url 'query-list' %}">New Query</a>
                    {% block content-delete %}
                        {% if delete_form %}
                        <form class="custom-inline" action="{{ request.get_full_path }}"
                              data-method="DELETE">
                            <button type="button" class="btn btn-sm btn-default js-tooltip"
                                    title="DELETE this query" id="DELETE_RESOURCE"
                                    data-toggle="modal"><i class="fa fa-trash-o text-red"></i> DELETE
                            </button>
                        </form>
                        <!-- Confirmation modal -->
                        <div class="modal fade" id="delete-modal-sm" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-sm">
                                <div class="modal-content">
                                    <div class="modal-body">
                                        <h5>Are you sure?</h5>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" data-dismiss="modal" class="btn btn-primary" id="delete">Delete
                                        </button>
                                        <button type="button" data-dismiss="modal" class="btn">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endblock %}
                </div>
            </div>
        </div>
        <div class="data-table-container" id="data-table-container">
        </div>
        {% if display_edit_forms %}
        <!--UPDATE EXISTING REQUEST INSTANCE-->
            {% if put_form or raw_data_put_form or raw_data_patch_form %}
                <div class="row">
                    <div class="col-xs-12">
                        <h2 class="headline"><span>Update</span> </h2>
                    </div>
                    <div class="col-sm-8">
                        <div class="well">
                            {% if put_form %}
                            <div class="" id="put-object-form">
                                <form action="{{ request.get_full_path }}" data-method="PUT" enctype="multipart/form-data"
                                      class="form-horizontal" novalidate>

                                        {{ put_form }}
                                        <div class="row">
                                            <div class="col-xs-12">
                                            <button class="btn btn-primary btn-sm js-tooltip pull-right"
                                                    title="Overwrite Query {{objname}}">SUBMIT
                                            </button>
                                                </div>
                                        </div>

                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="panel panel-default information">
                            <div class="panel-body">
                                <strong class="text-uppercase">Warning</strong>
                                <p>Submitting this form will override
                                    the previous query and results.
                                    Alternatively, you can create a
                                    <a type="button" class=""
                                       href="{% url 'query-list' %}">New Query</a>.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
{% endblock %}

{% comment %}
------ DISPLAY 404 AND SUGGESTIONS ------
{% endcomment %}
{% block status_override %}
    {% if response.status_code == 404 %}
        <a href="{% url "query-list" %}" class="btn btn-primary btn-md"><i class="fa fa-angle-left"></i> Back to Query List</a>
        <a href="{% url "index" %}" class="btn btn-primary btn-md">Home</a>
    {% else %}
        {% if user.is_authenticated %}
          {% load internal_extras %}
          {% optional_logout request user %}
        {% else %}
          {% optional_login request %}
        {% endif %}
    {% endif %}
{% endblock %}


{% comment %}
------ TURN OFF DRF JSON DATA DISPLAY ------
{% endcomment %}
{% block content-DRFs %}{% endblock %}

{% comment %}
------ ACE EDITOR FOR ANY SQL BOXES ------
{% endcomment %}
{% block footer-extra %}
<script src="{% static "restapi_app/js/ace-min-noconflict/ace.js" %}"></script>

<script type="text/javascript">
        $(document).ready(function() {
            $('form').ajaxForm();

//            // CODE EDITOR
//            $(function () {
//                //Hide the results form group to prevent users trying to patch results
//                //back-end will drop this if tampered with
//                $('input[name="queryResults"]').parents('.form-group').hide();
//
//                // SQL
//                $('textarea[name=SQL]').each(function () {
//                    $('form').find('textarea[name=SQL]').attr('id','textarea-code');
//
//                    // clear out parent container
//                    $('#textarea-code').parent().not(':first').remove();
//                    $('#textarea-code').parent().append('<div id="SQL-ace-editor" class="ace-editor-class" style="height: auto;min-height:100px"></div>');
//                    var textarea = $('#textarea-code').css('display', 'none');
//
//                    var SQLAceEditor = ace.edit("SQL-ace-editor");
//                    SQLAceEditor.$blockScrolling = Infinity;
//                    SQLAceEditor.setTheme("ace/theme/crimson_editor");
//                    SQLAceEditor.setOption("maxLines", 20);
//                    SQLAceEditor.setOption("minLines", 10);
//                    SQLAceEditor.getSession().setMode("ace/mode/sql");
//                    SQLAceEditor.getSession().setValue(textarea.val());
//                    SQLAceEditor.getSession().on('change', function(){
//                        textarea.val(SQLAceEditor.getSession().getValue());
//                        SQLAceEditor.resize(true);
//                    });
//                });
//            });
//            $('#button-sql-submit').click(function(){
//                $(this).attr('disabled','disabled');
//                $(this).html('SUBMITTING... <i class="fa fa-refresh fa-spin fa-1x fa-fw"></i>')
//            });
        });
</script>

{% comment %}
------ TURN ON DATATABLES ------
{% endcomment %}
<script src="{% static 'restapi_app/js/query-builder/dataTables.js' %}"></script>
<!--<script type="text/javascript" src="https://cdn.datatables.net/s/bs/dt-1.10.10/datatables.min.js"></script>-->

{% autoescape off %}
 <script type="text/javascript">
    data = JSON.parse("{{ content|escapejs }}");

    if (typeof data.queryResults !== 'undefined'){
        $('#data-table-container').html(' ').append('<div class=""><div id="returnTableResultsWarning" class="spacer-10"></div><table id="returnTableResults" class="table table-responsive table-condensed"><thead><tr><th>Please wait, DataTable loading... <i class="fa fa-refresh fa-spin"></i></th></tr></thead></table></div>')
        renderLimit = 10000;
        queryData = (data.queryResults);
        queryDataRows = queryData.data.length;
        queryDataColumns = queryData.columns.length;
        //console.log(queryDataRows);
        //console.log(queryDataColumns);

        if (queryDataRows*queryDataColumns >= renderLimit){
            //fire warning
            tableRowLength = parseInt(renderLimit/queryDataColumns);
            //console.log(queryData.data.slice(0, tableRowLength).length);
            queryData.data = queryData.data.slice(0, tableRowLength);

            $('#returnTableResultsWarning').append('<div class="row"><div class="col-sm-12"><div class="panel panel-default information"><div class="panel-body"><strong class="text-uppercase">Warning</strong><p>Displaying '+tableRowLength+' out of '+queryDataRows+' rows. Please download the CSV file to explore the full set of results.</p></div></div></div></div>')
        };

        if((typeof queryData !== 'undefined') && queryData.data.length < renderLimit){
            var queryColumns = [];
            var thead = '';
            $('#returnTableResults').find('thead > tr').empty();
            //APPEND COLUMN VALUES TO TABLE HEAD
            $.each(queryData.columns, function(i,k){
                var b = { title: k };

                if (k.indexOf("url_img") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            return '<img class="img-responsive" style="max-width:70px" src="'+data+'" />';
                        }
                    }
                }
                th = '<th>'+k+'</th>';
                queryColumns.push(b);
                $('#returnTableResults').find('thead > tr').append(th);
            });
            var data = queryData.data;

            if (typeof data == 'undefined'){data=[];}

            var table = $('#returnTableResults').DataTable( {
                data : data,
                columns : queryColumns,
                "orderClasses": false,
                "scrollX": true,
                "deferRender": true,
                "language": {
                    "loadingRecords": "Please wait - loading..."
                }
            });

            $('#returnTableResults_filter input').unwrap().wrap("<div class='input-group' role='search'></div>")
                    .addClass('form-control')
                    .attr('placeholder', 'SEARCH...')
                    .after('<span class="input-group-btn"> <button class="btn btn-default btn-sm" type="button"><i class="fa fa-search fa-fw"></i></button> </span>');
            document.getElementById('returnTableResults_filter').firstChild.data = "";
            $('#returnTableResults_length, #returnTableResults_filter').parent('.col-sm-6').addClass('col-xs-6');

        };
    };

    {% endautoescape %}
</script> 

{% comment %}
------ CONFIRM RESOURCE DELETE ------
{% endcomment %}
<script>
    $('#DELETE_RESOURCE').on('click', function(e){
        var $form=$(this).closest('form');
        e.preventDefault();
        $('#delete-modal-sm').modal({ backdrop: 'static', keyboard: false })
        .one('click', '#delete', function (e) {
            $form.trigger('submit');
        });
    });

    fTabSwitch = function(id){
        $('[href=#'+id+']').tab('show');
    }
</script>
<script>
    // Check slug for #anchor, change tab view if appropriate
    function fchange_tab() {
        var url = window.location.href;
        var hash = url.substring(url.indexOf("#") + 1);
        if (hash == 'query-builder-form' || hash == 'post-object-form') {
            $('#query-builder-form').removeClass('active');
            $('#post-object-form').removeClass('active');

            $('a[href="#query-builder-form"]').parent('li').removeClass('active');
            $('a[href="#post-object-form"]').parent('li').removeClass('active');

            $('#' + hash).addClass('active');
            $('a[href="#' + hash + '"]').parent('li').addClass('active');
        }
    }
    ;

    fchange_tab();

    $('.li-query').click(function () {
        // bind navigation after 0.5s
        // ensures url has changed and will read new hash
        setTimeout(function () {
            fchange_tab();
        }, 500);

    });

</script>
{% endblock %}

