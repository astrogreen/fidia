{% extends 'rest_framework/api.html' %}
{% load staticfiles %}
{% load rest_framework %}
{% load i18n %}
{% load internal_extras %}
{% block title %}Query{% endblock %}
{% block head-extra %}

<script type="text/javascript">
    //get url for available catalogues
    urlCataloguesGlobal = "{% url "catalogues" %}"
</script>
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/less/schema-browser/schema-browser.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/less/query/data-tables.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'restapi_app/less/ace/ace.css' %}"/>

<link rel="stylesheet" href="{% static 'restapi_app/less/query/query-builder.css' %}" type="text/css"/>


<style type="text/css">
    table{
        table-layout: fixed;
    }
    table tr {
        height:1em;
    }
    td {
        overflow:hidden;white-space:nowrap;
    }
    .nav-pagination{
        background-color:transparent;
        float:right;
    }
    #SQL-ace-editor{border:solid 1px #eeeeee;}

</style>
{% block head-extra-extra%}{% endblock %}
{% endblock %}

{% block bodyclass %}{% endblock %}
{% block breadcrumbclass %}{% endblock %}

{% block content-filter-form %}{% endblock %}
{% block content-header %}{% endblock %}

{% block angular-ng-app-class %}ng-app="myApp"{% endblock %}
{% block content %}
    {% captureas status_code %}{% status_is_success response.status_code %}{% endcaptureas %}

    {% if status_code == 'True' %}

        {% comment %}
        ------DATATABLES ------
        {% endcomment %}
        {% if response.data.queryResults %}
            <div class="row">
                <div class="col-sm-6">
                    <h1 class="headline">
                        <span>{% if response.data.title %}{{response.data.title |truncatechars:30}}{% else %} Query # {{objname}} {% endif %}</span>
                    </h1>
                </div>
                <div class="col-sm-6">
                    <div class="btn-group btn-group-head pull-right" role="group" aria-label="">
                        {% block content-download %}
                            {% if 'GET' in allowed_methods %}
                                <form id="download-list" class="custom-inline">
                                    {% if api_settings.URL_FORMAT_OVERRIDE %}
                                    <div class="btn-group format-selection">
                                        <button class="btn btn-default btn-sm dropdown-toggle js-tooltip" data-toggle="dropdown" title="Specify a format for data download">
                                            DOWNLOAD <i class="fa fa-caret-down"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            {% for format in available_formats %}
                                            {% if format != "api" %}
                                                <li>
                                                    <a class="js-tooltip" href="{% add_query_param request api_settings.URL_FORMAT_OVERRIDE format %}"
                                                       rel="nofollow" target="_blank"  title="Download query # {{ objname }} with the format set to `{{ format }}`">{{ format }}</a>
                                                </li>
                                            {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% else %}
                                        <a class="btn btn-default btn-sm js-tooltip" href="{{ response.data.url }}" rel="nofollow"
                                           title="Download {{user}}'s query # {{objname}}">PERMANENT LINK</a>
                                    {% endif %}
                                </form>
                            {% endif %}
                        {% endblock %}
                        <!--<a type="button" class="btn btn-default btn-sm text-uppercase" href="{{ response.data.url }}">Permanent Link</a>-->
                        <a type="button" class="btn btn-default btn-sm text-uppercase" href="{% url 'query-list' %}"><i
                            class="fa fa-caret-left"></i> Back to Query History</a>
                        <a type="button" class="btn btn-default btn-sm text-uppercase" href="{% url 'query-create-list' %}">New Query</a>
                        {% block content-delete %}
                            {% if delete_form %}
                            <form class="custom-inline" action="{{ request.get_full_path }}"
                                  data-method="DELETE">
                                <button type="button" class="btn btn-sm btn-default js-tooltip"
                                        title="DELETE this query" id="DELETE_RESOURCE"
                                        data-toggle="modal"><i class="fa fa-trash-o text-red"></i> DELETE
                                </button>
                            </form>
                            <!-- Confirmation modal -->
                            <div class="modal fade" id="delete-modal-sm" tabindex="-1" role="dialog">
                                <div class="modal-dialog modal-sm">
                                    <div class="modal-content">
                                        <div class="modal-body">
                                            <h5>Are you sure?</h5>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" data-dismiss="modal" class="btn btn-primary" id="delete">Delete
                                            </button>
                                            <button type="button" data-dismiss="modal" class="btn">Cancel</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endblock %}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12"><div id="TableResultsWarning"></div></div>
            </div>
            <div class="data-table-container" id="data-table-container">
            </div>
            {% if display_edit_forms %}
            <!--UPDATE EXISTING REQUEST INSTANCE-->
                {% if put_form or raw_data_put_form or raw_data_patch_form %}
                    <div class="row">
                        <div class="col-xs-12">
                            <h2 class="headline"><span>Update</span> </h2>
                        </div>
                        <div class="col-sm-8">
                            <div class="well">
                                {% if put_form %}
                                <div class="" id="put-object-form">
                                    <form action="{{ request.get_full_path }}" data-method="PUT" enctype="multipart/form-data"
                                          class="form-horizontal" novalidate>

                                            {{ put_form }}
                                            <div class="row">
                                                <div class="col-xs-12">
                                                <button class="btn btn-primary btn-sm js-tooltip pull-right"
                                                        title="Overwrite Query {{objname}}" id="button-sql-update">UPDATE
                                                </button>
                                                    </div>
                                            </div>

                                    </form>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-sm-4">
                            <div class="panel panel-default warning">
                                <div class="panel-body">
                                    <strong class="text-uppercase">Warning</strong>
                                    <p>Submitting this form will override
                                        the previous query and results.
                                        Alternatively, you can create a
                                        <a type="button" class=""
                                           href="{% url 'query-create-list' %}">New Query</a>.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endif %}
    {% endif %}
{% endblock %}


{% comment %}
------ ACE EDITOR FOR ANY SQL BOXES ------
{% endcomment %}
{% block footer-extra %}
<script src="{% static "restapi_app/js/ace-min-noconflict/ace.js" %}"></script>

<script type="text/javascript">
        $(document).ready(function() {
            $('form').ajaxForm();

            // CODE EDITOR
            $(function () {
                //Hide the results form group to prevent users trying to patch results
                //back-end will drop this if tampered with
                $('input[name="queryResults"]').parents('.form-group').hide();

                // SQL
                $('textarea[name=SQL]').each(function () {
                    $('form').find('textarea[name=SQL]').attr('id','textarea-code');

                    // clear out parent container
                    $('#textarea-code').parent().not(':first').remove();
                    $('#textarea-code').parent().append('<div id="SQL-ace-editor" class="ace-editor-class" style="height: auto;min-height:100px"></div>');
                    var textarea = $('#textarea-code').css('display', 'none');

                    var SQLAceEditor = ace.edit("SQL-ace-editor");
                    SQLAceEditor.$blockScrolling = Infinity;
                    SQLAceEditor.setTheme("ace/theme/crimson_editor");
                    SQLAceEditor.setOption("maxLines", 20);
                    SQLAceEditor.setOption("minLines", 10);
                    SQLAceEditor.getSession().setMode("ace/mode/sql");
                    SQLAceEditor.getSession().setValue(textarea.val());
                    SQLAceEditor.getSession().on('change', function(){
                        textarea.val(SQLAceEditor.getSession().getValue());
                        SQLAceEditor.resize(true);
                    });
                });
            });
            $('#button-sql-update').click(function(){
                $(this).attr('disabled','disabled');
                $(this).html('SUBMITTING... <i class="fa fa-refresh fa-spin fa-1x fa-fw"></i>');
                $('#put-object-form form').submit();
            });
        });
</script>

{% comment %}
------ TURN ON DATATABLES ------
{% endcomment %}
<script src="{% static 'restapi_app/js/query-builder/dataTables.js' %}"></script>
<!--<script type="text/javascript" src="https://cdn.datatables.net/s/bs/dt-1.10.10/datatables.min.js"></script>-->

{% autoescape off %}
 <script type="text/javascript">
    data = JSON.parse("{{ content|escapejs }}");

    if (typeof data.queryResults !== 'undefined'){
        $('#data-table-container').html(' ').append('<div class=""><div id="returnTableResultsWarning" class="spacer-10"></div><table id="returnTableResults" class="table table-responsive table-condensed"><thead><tr><th>Please wait, DataTable loading... <i class="fa fa-refresh fa-spin"></i></th></tr></thead></table></div>')

        render_limit = 10000;
        query_data = (data.queryResults);

        query_data_row_length = query_data.data.length;
        query_data_col_length = query_data.columns.length;

        if (data.flag != "") {
            $('#TableResultsWarning').append('<div class="row"><div class="col-sm-12"><div class="panel panel-default information"><div class="panel-body"><strong class="text-uppercase">Warning</strong><p>Displaying '+data.flag.new_query_results_rows+' out of '+data.flag.query_results_rows+' rows. Please download the CSV file to explore the full set of results.</p></div></div></div></div>');
            render_limit = data.flag.render_limit;
        }

        if((typeof query_data !== 'undefined') && query_data.data.length < render_limit){
            var queryColumns = [];
            var thead = '';
            $('#returnTableResults').find('thead > tr').empty();
            //APPEND COLUMN VALUES TO TABLE HEAD
            $.each(query_data.columns, function(i,k){
                var b = { title: k };

                if (k.indexOf("url_img") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            return '<img class="img-responsive" style="max-width:70px" src="'+data+'" />';
                        }
                    }
                }
                if (k.indexOf("data_browser_url") > -1){
                    b = {
                        "title":k,
                        "render": function(data, type, row) {
                            var temp_string = '<a href="'+data+'" target="_blank">'+data+'</a>';
                            return temp_string;
                        }
                    }
                }
                th = '<th>'+k+'</th>';
                queryColumns.push(b);
                $('#returnTableResults').find('thead > tr').append(th);
            });
            var data = query_data.data;

            if (typeof data == 'undefined'){data=[];}

            var table = $('#returnTableResults').DataTable( {
                data : data,
                columns : queryColumns,
                "orderClasses": false,
                "scrollX": true,
                "deferRender": true,
                "language": {
                    "loadingRecords": "Please wait - loading..."
                }
            });

            $('#returnTableResults_filter input').unwrap().wrap("<div class='input-group' role='search'></div>")
                    .addClass('form-control')
                    .attr('placeholder', 'SEARCH...')
                    .after('<span class="input-group-btn"> <button class="btn btn-default btn-sm" type="button"><i class="fa fa-search fa-fw"></i></button> </span>');
            document.getElementById('returnTableResults_filter').firstChild.data = "";
            $('#returnTableResults_length, #returnTableResults_filter').parent('.col-sm-6').addClass('col-xs-6');

        };
    };

    {% endautoescape %}
</script> 

{% comment %}
------ CONFIRM RESOURCE DELETE ------
{% endcomment %}
<script>
    $('#DELETE_RESOURCE').on('click', function(e){
        var $form=$(this).closest('form');
        e.preventDefault();
        $('#delete-modal-sm').modal({ backdrop: 'static', keyboard: false })
        .one('click', '#delete', function (e) {
            $form.trigger('submit');
        });
    });

    fTabSwitch = function(id){
        $('[href=#'+id+']').tab('show');
    }
</script>
{% endblock %}

