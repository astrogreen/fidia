{% extends 'rest_framework/api.html' %}
{% load staticfiles %}
{% load rest_framework %}
{% load i18n %}
{% load internal_extras %}


{% block query-form %}
   <div class="response-info" style="clear: both">
                <div class="response-info" style="clear: both">
                  <pre class="prettyprint"><span class="meta nocode"><b>HTTP {{ response.status_code }} {{ response.status_text }}</b>{% autoescape off %}
    {% for key, val in response_headers.items %}<b>{{ key }}:</b> <span class="lit">{{ val|break_long_headers|urlize_quoted_links }}</span>
    {% endfor %}
    </span><div class="ace-editor-class" id="JSON-ace-editor" style="height: auto;min-height:200px">{{ content|urlize_quoted_links }}{% endautoescape %}</div>
                </div></pre>
              </div>
{% endblock %}

{% block footer-extra %}
    <script src="{% static "restapi_app/js/ace-min-noconflict/ace.js" %}"></script>

     <script type="text/javascript"> 
     $(document).ready(function() {
        $('form').ajaxForm();

        // CODE EDITOR
        $(function () {
          // SQL
          $('textarea[name=SQL]').each(function () {             
              $('form').find('textarea[name=SQL]').attr('id','textarea-code');
              $('#textarea-code').parent().append('<div id="SQL-ace-editor" class="ace-editor-class" style="height: auto;min-height:100px"></div>');  
              var SQLAceEditor = ace.edit("SQL-ace-editor"); 
              SQLAceEditor.$blockScrolling = Infinity;
              SQLAceEditor.setTheme("ace/theme/crimson_editor"); 
              SQLAceEditor.getSession().setMode("ace/mode/sql");  
              var textarea = $('#textarea-code').css('display', 'none'); 
              SQLAceEditor.getSession().setValue(textarea.val());  
              SQLAceEditor.getSession().on('change', function(){
                textarea.val(SQLAceEditor.getSession().getValue()); 
                SQLAceEditor.resize(true); 
              });
          });

          // JSON RESPONSE (OFF)
          $('#JSON-ace-editors').each(function () {             
              var JSONAceEditor = ace.edit("JSON-ace-editor"); 
              JSONAceEditor.$blockScrolling = Infinity;
              JSONAceEditor.setTheme("ace/theme/crimson_editor"); 
              JSONAceEditor.getSession().setMode("ace/mode/json");  
              //JSONAceEditor.getSession().foldAll();
          });
        });

    });
    </script>

    <script type="text/javascript" src="https://cdn.datatables.net/s/bs/dt-1.10.10/datatables.min.js"></script>
        {% autoescape off %}
           <script type="text/javascript"> 
          data = JSON.parse("{{ content|escapejs }}");
          if (typeof data.queryResults !== 'undefined'){
          console.log('trigger');
            $('.data-table-container').html('').append('<div class="well"><div id="returnTableResultsWarning" class="spacer-10"></div><table id="returnTableResults" class="table table-responsive table-condensed"><thead><tr><th>Please wait, DataTable loading... <i class="fa fa-refresh fa-spin"></i></th></tr></thead></table></div>')

            renderLimit = 100;
            queryData = (data.queryResults);
            queryDataRows = queryData.data.length;
            queryDataColumns = queryData.columns.length;

            if (queryDataRows*queryDataColumns >= renderLimit){
              //fire warning
              tableRowLength = parseInt(renderLimit/queryDataColumns);
              console.log(queryData.data.slice(0, tableRowLength).length);
              queryData.data = queryData.data.slice(0, tableRowLength);

              $('#returnTableResultsWarning').append('<p class="bg-info"><p class="bg-info"><strong>Displaying '+tableRowLength+' out of '+queryDataRows+' rows</strong>. Please download the CSV for the full data set.</p>')
            };

            if((typeof queryData !== 'undefined') && queryData.data.length < renderLimit){
              var queryColumns = [];
              var thead = '';
              $('#returnTableResults').find('thead > tr').empty();
              //APPEND COLUMN VALUES TO TABLE HEAD
              $.each(queryData.columns, function(i,k){
                var b = { title: k };

                if (k.indexOf("url_img") > -1){
                    b = {
                    "title":k,
                    "render": function(data, type, row) {
                            return '<img class="img-responsive" style="max-width:70px" src="'+data+'" />';
                        }
                    }
                }
                th = '<th>'+k+'</th>';
                queryColumns.push(b);
                $('#returnTableResults').find('thead > tr').append(th);
              });
              var data = queryData.data;

              if (typeof data == 'undefined'){data=[];}

              var table = $('#returnTableResults').DataTable( {
                data : data,
                columns : queryColumns,
                "orderClasses": false,
                "scrollX": true,
                "deferRender": true,
                "language": {
                     "loadingRecords": "Please wait - loading..."
                  }
               });
            };
          };

    {% endautoescape %}
    </script> 

{% endblock %}