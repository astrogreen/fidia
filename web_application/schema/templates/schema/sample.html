{% extends 'rest_framework/api.html' %}
{% load staticfiles %}
{% load rest_framework %}
{% load internal_extras %}
{% block title %} Schema Browser {% endblock %}
{% block head-extra %}
<link rel="stylesheet" type="text/css" href="{% static 'data_browser/css/sample/sample.min.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'data_browser/css/trait/trait.min.css' %}"/>
<link rel="stylesheet" type="text/css" href="{% static 'schema/css/schema/schema.min.css' %}"/>
{% endblock %}

{% block page_title %}Schema Browser{% endblock %}
{% block useful_links %}
<li role="presentation"><a href="{% url 'data_browser:root-list' %}">Data Browser</a></li>
{% endblock useful_links %}

{% block content-navigator-help %}
<a href="{% url 'schema:schema-list' %}" class=""><i class="fa fa-reply"></i> Back to Surveys</a>
{% endblock %}

{% block content-test %}
{% captureas survey %}{{response.data.sample}}{% endcaptureas %}

<div class="row schema-browser">
    <div class="col-xs-12">
        <div class="title_info">
            <h2>Schema for {{survey|uppercase}}
                <small class="right-helper">
                    <!--<span class="sub-heading"><i class="fa fa-map-marker"></i> DR 1.0</span>&nbsp;&nbsp;-->
                    <div class="btn-group" role="group" style="margin-top:-15px;">
                        <button type="button" class="btn btn-default dropdown-toggle"
                                data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false">
                            <span class="sub-heading">
                                <i class="fa fa-map-marker"></i> Data Release:
                            </span>
                            <strong>1.0</strong>
                            <i class="fa fa-caret-down"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li class="disabled"><a href="">DR 1.0 &nbsp;
                                <small class="sub-heading text-uppercase">Current</small>
                            </a></li>
                        </ul>
                    </div>
                </small>
            </h2>
            <p>The Schema Browser describes the {{survey|uppercase}} survey data products. It is recommended
                that you also use the <a href="">{{survey|uppercase}} Documentation</a> in conjunction with the
                Schema
                Browser, which contains a more comprehensive description of pipeline reduction and analysis
                techniques.
            </p>
        </div>
    </div>

    <div class="col-sm-3 col-xs-12 menu-nav schema" id="menu-nav">
        <h5>Contents</h5>
        <ul class="nav nav-pills nav-stacked docs-sidebar" id="docs-sidebar">
            {% for trait_type_key, trait_type_value in response.data.schema.trait_types.items %}
            <li class="text-uppercase heading {% if forloop.first %}no-margin-top{% endif %}">
                <h6>{{trait_type_value.pretty_name}}</h6>
            </li>
                {% for trait_qualifier_key, trait_qualifier_value in trait_type_value.trait_qualifiers.items %}
                    <li class="{% if forloop.parentloop.first and forloop.first %}active{% endif %}" role="presentation">
                        <a href="#{{trait_type_key}}_{{trait_qualifier_key}}"
                           aria-controls="{{trait_type_key}}_{{trait_qualifier_key}}" role="tab"
                           data-toggle="pill">{{trait_qualifier_value.pretty_name}}
                            {% if not trait_qualifier_value.pretty_name %}
                                {{trait_type_value.pretty_name}}
                            {% endif %}
                            <!--<small>{{trait_type_key}}_{{trait_qualifier_key}}</small>-->
                        </a>
                    </li>
                {% endfor %}
            {% endfor %}
        </ul>
    </div>
    <div class="col-sm-9 col-xs-12 right-panel">
        <div class="row">
            <div class="col-xs-12 schema-contents">
                {% comment %}
                {% for trait_type_key, trait_type_value in response.data.schema.trait_types.items %}
                    {{trait_type_key}}
                    {% for trait_qualifier_key, trait_qualifier_value in trait_type_value.trait_qualifiers.items %}
                    &nbsp;{{trait_qualifier_key}}
                        {% for trait_branch_key, trait_branch_value in trait_qualifier_value.branches.items %}
                            &nbsp;&nbsp;{{trait_branch_key}}
                                {% for trait_version_key, trait_version_value in trait_branch_value.items %}
                                    &nbsp;&nbsp;{{trait_version_key}}
                                    {{trait_version_value.pretty_name}}
                                {% endfor %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
                {% endcomment %}
                <div class="tab-content">
                    <!--<div class="pull-right sub-heading">Change branch or version</div><br>-->
                    {% for trait_type_key, trait_type_value in response.data.schema.trait_types.items %}
                        {% for trait_qualifier_key, trait_qualifier_value in trait_type_value.trait_qualifiers.items %}
                            <div id="{{trait_type_key}}_{{trait_qualifier_key}}" class="tab-pane branch_dropdown {% if forloop.parentloop.first and forloop.first %}active{% endif %} ">
                                <ul class="nav nav-pills pull-right branch-selector">
                                    <li class="dropdown keep-open">
                                        <a class="btn btn-default branch_button" data-toggle="dropdown" href="#" aria-haspopup="true" aria-expanded="false">
                                           <span class="sub-heading"><i class="fa fa-code-fork"></i> Branch: </span>

                                                {% for trait_branch_key, trait_branch_value in trait_qualifier_value.branches.items %}
                                                    {% for trait_version_key, trait_version_value in trait_branch_value.versions.items %}
                                                        <!--Default branch, and the default version for that branch, are set as active-->
                                                        {% if trait_qualifier_value.default_branch == trait_branch_key and trait_branch_value.default_version == trait_version_key %}
                                                            <strong>{{trait_branch_value.pretty_name}}</strong> <span class="sub-heading"><i class="fa fa-map-pin"></i> Version: </span>  <strong> {{trait_version_value.pretty_name}}</strong>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endfor %}

                                            <i class="fa fa-caret-down"></i>
                                        </a>
                                        <ul class="dropdown-menu" style="margin-top:0;padding-top:0;">

                                            <li class="dropdown-header dropdown-header-bold">
                                                Switch branch and/or version
                                            </li>
                                            <li class="dropdown-header">
                                                Available Branches
                                            </li>
                                            <li role="separator" class="divider"></li>

                                            {% for trait_branch_key, trait_branch_value in trait_qualifier_value.branches.items %}
                                                <li class="dropdown-header dropdown-header-sub">
                                                        <strong><i class="fa fa-code-fork"></i> {{trait_branch_value.pretty_name}}</strong>
                                                        {% if trait_qualifier_value.default_branch == trait_branch_key %}
                                                            <small class="tiny pull-right">DEFAULT</small>
                                                        {% endif %}
                                                </li>
                                                <li class="dropdown-header versions">
                                                    Versions
                                                </li>
                                                {% for trait_version_key, trait_version_value in trait_branch_value.versions.items %}

                                                    <!--Default branch, and the default version for that branch, are set as active-->
                                                    <li class="{% if trait_qualifier_value.default_branch == trait_branch_key and trait_branch_value.default_version == trait_version_key %}active{% endif %}">
                                                        <a class="versions" href="#{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}"
                                                           data-toggle="tab" role="tab" data-branch="{{trait_branch_value.pretty_name}}" data-version="{{trait_version_value.pretty_name}}">
                                                            <strong> <i class="fa fa-map-pin"></i> {{trait_version_value.pretty_name}}
                                                            {% if trait_branch_value.default_version == trait_version_key %}
                                                                <small class="tiny pull-right" style="margin-top:2px;">LATEST</small>
                                                            {% endif %}
                                                            </strong>
                                                        </a>
                                                    </li>
                                                {% endfor %}
                                                <li role="separator" class="divider"></li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    {% for trait_branch_key, trait_branch_value in trait_qualifier_value.branches.items %}
                                        {% for trait_version_key, trait_version_value in trait_branch_value.versions.items %}

                                            <div id="{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}"
                                                 class="tab-pane {% if trait_qualifier_value.default_branch == trait_branch_key and trait_branch_value.default_version == trait_version_key %}active{% endif %}">

                                                    {% with trait_version_value.trait as value %}

                                                        <h3>{{trait_type_value.pretty_name}} {{trait_qualifier_value.pretty_name}}
                                                            <!--<small>{{trait_branch_value.pretty_name}} {{trait_version_value.pretty_name}}</small>-->
                                                        </h3>
                                                        <p><em>{% if value.description %}{{value.description}}{% endif %}</em></p>
                                                        <h4>Branch & Version</h4>
                                                        <p>You are currently viewing the {{trait_type_value.pretty_name}}
                                                            {{trait_qualifier_value.pretty_name}} Schema for
                                                            branch <strong class="text-danger"> <em>{{trait_branch_value.pretty_name}}
                                                            </em></strong>, version number <strong class="text-danger">
                                                                <em>{{trait_version_value.pretty_name}}</em></strong>.
                                                        </p>
                                                        <p><span class="sub-heading">
                                                                    <i class="fa fa-code-fork"></i> Branch: </span>
                                                                <strong>{{trait_branch_value.pretty_name}}
                                                                {% if trait_qualifier_value.default_branch == trait_branch_key %}
                                                                    <small>[DEFAULT]</small>
                                                                {% endif %}
                                                                </strong>:
                                                        {{trait_branch_value.description}}
                                                        </p>
                                                        <p>
                                                            <span class="sub-heading"><i class="fa fa-map-pin"></i> Version: </span><strong>{{trait_version_value.pretty_name}}</strong>
                                                            {{trait_version_value.description}}
                                                        </p>

                                                        <div class="panel panel-default success">
                                                            <div class="panel-body">
                                                                <div class="sub-heading">This document is for the {{trait_type_value.pretty_name}} {{trait_qualifier_value.pretty_name}}
                                                            <strong> branch <em>{{trait_branch_value.pretty_name}}</em>, version <em>{{trait_version_value.pretty_name}}</em></strong>, which can be
                                                                    significantly different from other branches/versions. To switch branches/versions, use the
                                                                    selector floating in the top right corner of this panel. For more information
                                                                    on branches,
                                                                    <a href="{% url 'documentation:article-detail' slug='branches-what-is-a-branch' %}">
                                                                        view the documentation.</a>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <h4>Contents</h4>
                                                        <ul class="p">
                                                            <li><a href="#{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_description" class="scroll">Description</a></li>
                                                            <li><a href="#{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_properties" class="scroll">Properties</a></li>
                                                            <li><a href="#{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_formats" class="scroll">Formats</a></li>
                                                            <li><a href="#{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_branches" class="scroll">All Available Branches and Previous Versions</a></li>
                                                        </ul>

                                                        <!-- Documentation -->
                                                        <h4 id="{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_description">Description</h4>
                                                        <div class="well-ignore" style="margin-bottom:20px;">
                                                            {{value.html_documentation|safe}}
                                                            <hr>
                                                        </div>

                                                        <!-- Properties-->
                                                        <h4 id="{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_properties">Properties</h4>
                                                        <div class="table-responsive">
                                                            <table class="table table-bordered table-striped">
                                                                <thead>
                                                                <tr>
                                                                    <th>Name</th>
                                                                    <th>Type</th>
                                                                    <th>Description</th>
                                                                    <th>Documentation</th>
                                                                </tr>
                                                                </thead>
                                                                <tbody>

                                                                {% for trait_property_key, trait_property_value in value.trait_properties.items %}
                                                                    <tr>
                                                                        <td>{{trait_property_value.pretty_name}}</td>
                                                                        <td><code>{{trait_property_value.type}}</code></td>
                                                                        <td><em>{{trait_property_value.description}}</em></td>
                                                                        <td>{{trait_property_value.html_documentation}}</td>
                                                                    </tr>
                                                                {% endfor %}
                                                                </tbody>
                                                            </table>
                                                        </div>

                                                        <!-- Formats -->
                                                        <h4 id="{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_formats">
                                                             Formats
                                                        </h4>
                                                        <p>
                                                            <span class="fa-custom-stack">
                                                              <i class="fa fa-file-o"></i>
                                                                <span class="fa-custom-filetype">fits</span>
                                                            </span>fits,
                                                            <span class="fa-custom-stack">
                                                              <i class="fa fa-file-o"></i>
                                                                <span class="fa-custom-filetype">json</span>
                                                            </span>json
                                                        </p>


                                                        <!-- Branches -->
                                                        <h4 id="{{trait_type_key}}_{{trait_qualifier_key}}_{{trait_branch_key}}_{{trait_version_key}}_branches">
                                                             All Available Branches and Previous Versions
                                                        </h4>
                                                        <p>{{trait_type_value.pretty_name}} {{trait_qualifier_value.pretty_name}} has {{trait_qualifier_value.branches |length }} available branch(es).
                                                            In this section, you may find descriptions of each branch and version for reference.

                                                            To switch branches, use the
                                                            branch selector floating in the top right corner at the top
                                                            of this document. For more information
                                                            on branches,
                                                            <a href="{% url 'documentation:article-detail' slug='branches-what-is-a-branch' %}">
                                                                view the documentation</a>.
                                                        </p>

                                                        {% for trait_branch_key, trait_branch_value in trait_qualifier_value.branches.items %}
                                                            <div>
                                                                <em>
                                                                    <span class="sub-heading"><i class="fa fa-code-fork"></i> Branch: </span>
                                                                    <strong>{{trait_branch_value.pretty_name}}</strong>
                                                                    {% if trait_qualifier_value.default_branch == trait_branch_key %}
                                                                        <small>DEFAULT</small>
                                                                    {% endif %}
                                                                </em>
                                                                <p>{{trait_branch_value.description}}</p>
                                                            </div>


                                                            {% for trait_version_key, trait_version_value in trait_branch_value.versions.items %}
                                                                <div class="versions">
                                                                    <em>
                                                                        <span class="sub-heading"><i class="fa fa-map-pin"></i> Version: </span>
                                                                        <strong>{{trait_version_value.pretty_name}}</strong>
                                                                        {% if trait_branch_value.default_version == trait_version_key %}
                                                                            <small>LATEST</small>
                                                                        {% endif %}
                                                                    </em>
                                                                    <p>{{trait_version_value.description}}</p>
                                                                </div>
                                                            {% endfor %}
                                                        {% endfor %}

                                                    {% endwith %}

                                            </div>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block footer-extra %}
<script>

    $(window).on('resize, load', function () {
        // Sidebar menu height is at least panel height
        if ($(window).width() > 770) {
            if ($('.menu-nav').height()<$('.right-panel').height()){
                $('.menu-nav').height($('.right-panel').height() + 'px');
            }
        } else {
            $('.menu-nav').height('auto');
        }
    });


    $(document).ready(function () {
        $("ul.nav-pills a").click(function (e) {
          e.preventDefault();
            $(this).tab('show');
        });
        // Internally linked tab navigation (for branches and versions)
         $('.branch_dropdown > ul > li > a').click(function(){
             console.log('click');
         });

        // Change the text shown in the branch button.
        $('.branch_dropdown ul.dropdown-menu > li > a').click(function (event) {
            // note, currentTarget gets the element to which the event handler was attached to (rather than target, which gets the element on which the event occurred)
            var _anchor = $(event.currentTarget);
            // get nearest button
            _anchor.closest('ul.branch-selector').find('a.branch_button').html("<span class='sub-heading'><i class='fa fa-code-fork'></i> Branch: </span><strong>" + _anchor.attr('data-branch') + "</strong> <span class='sub-heading'><i class='fa fa-map-pin'></i> Version: </span><strong>" + _anchor.attr('data-version') + "</strong><i class='fa fa-caret-down'></i>");
        });

        $(".scroll").click(function(event){
            // stop the hash being appended to the url, and scroll to the value
            event.preventDefault();
            $('html, body').animate({scrollTop:$(this.hash).offset().top}, 800);
        });


    });

    

</script>
{% endblock %}
